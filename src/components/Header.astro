---
import HeaderLink from "./HeaderLink.astro";

import ThemeToggle from "./ThemeToggle.astro";
import LanguageToggle from "./LanguageToggle.astro";
import SearchOverlay from "./SearchOverlay.astro";

import { getCurrentLanguage } from "@i18n/i18n";
import { translations } from "@i18n/translations";

const lang = getCurrentLanguage(Astro);

const currentPath = Astro.url.pathname;

const hasTranslation =
  currentPath.startsWith(`/${lang}`) || currentPath == "/" || currentPath == "/404";

import "@styles/container.css";
import "@styles/utilities.css";
---

<header>
  <div class="container">
    <!-- Logo -->
    <div class="home">
      <a href={lang == "en" ? "/" : `/${lang}`} data-astro-prefetch="load">
        <span class="english-name">Lesley Lai</span>
        <span lang="zh">赖思理</span>
      </a>
    </div>
    <!-- Hamburger icon -->
    <input class="menu-icon" type="checkbox" id="menu-icon" />
    <label class="hamb" for="menu-icon"><span class="hamb-line"></span></label>
    <!-- Menu -->
    <nav class="menu" aria-label="main menu">
      <ul>
        <li><HeaderLink href=`/${lang}/blog`>{translations[lang].blog}</HeaderLink></li>
        <li>
          <HeaderLink href=`/${lang}/projects`>{translations[lang].projects.title}</HeaderLink>
        </li>
        <li>
          <HeaderLink href="https://notes.lesleylai.info/">{translations[lang].notes}</HeaderLink>
        </li>
        <li><HeaderLink href=`/${lang}/talks`>{translations[lang].talks}</HeaderLink></li>
        <li>
          <HeaderLink href=`/${lang}/about`>{translations[lang].about}</HeaderLink>
        </li>
      </ul>
    </nav>

    <ul class="menu header-right">
      <li><SearchOverlay /></li>
      <li><ThemeToggle /></li>
      {
        hasTranslation && (
          <li>
            <LanguageToggle />
          </li>
        )
      }
    </ul>
  </div>
</header>

<style>
  header {
    background-color: var(--header-bg-color);
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid var(--divider-color);
    transition: top 0.2s ease-in-out;
  }

  /* Use to hide the header when we scroll down on mobile devices */
  .header-hidden {
    top: -60px;
  }

  .container {
    justify-content: space-between;
    display: flex;
    flex-direction: column;
  }

  .home {
    font-size: 2em;
    padding: 0.2rem var(--content-padding);
    white-space: nowrap;
  }

  .home > a {
    color: var(--text-color);
    display: flex;
    gap: 0.3em;
  }

  /* menu elements are hidden by default in mobile by setting max-height to 0 */
  .menu {
    max-height: 0;
    overflow-y: hidden;
    transition: max-height 0.5s ease-out;
  }

  nav {
    width: 100%;
    height: 100%;
    border-top: 1px solid var(--divider-color);
  }

  :global(.dark) nav {
    box-shadow: unset;
  }

  nav ul {
    display: flex;
    flex-direction: column;
    margin: auto 0;
    border-bottom: 1px solid var(--divider-color);
  }

  nav ul li {
    padding: 10px 0;
  }

  /* Right part of the header including search, theme toggle, and language toggle */
  .header-right {
    display: flex;
    flex-direction: row;
    flex-shrink: 0;
    gap: 20px;
    padding: 0 10px;
    margin-right: var(--content-padding);
  }

  .header-right li {
    padding: 10px 0;
    margin: 0;
    display: flex;
    font-size: 0.9rem;
  }

  /* Menu Icon */
  .hamb {
    cursor: pointer;
    float: right;
    padding: 30px 20px;

    position: absolute;
    top: 0;
    right: 10px;
  } /* Style label tag */

  .hamb-line {
    background: var(--text-color);
    display: block;
    height: 2px;
    position: relative;
    width: 24px;
  } /* Style span tag */

  .hamb-line::before,
  .hamb-line::after {
    background: var(--text-color);
    content: "";
    display: block;
    height: 100%;
    position: absolute;
    transition: all 0.2s ease-out;
    width: 100%;
  }
  .hamb-line::before {
    top: 7px;
  }
  .hamb-line::after {
    top: -7px;
  }

  .menu-icon {
    display: none; /* hide checkbox */
  }

  .menu-icon:checked ~ nav {
    /* CSS can't perform transition on percentiles like 100%, so we just use a value larger than the nav can be */
    max-height: 400px;
  }
  .menu-icon:checked ~ .header-right {
    max-height: 100px;
  }
  .menu-icon:checked ~ .hamb .hamb-line {
    background: transparent;
  }
  .menu-icon:checked ~ .hamb .hamb-line::before {
    transform: rotate(-45deg);
    top: 0;
  }
  .menu-icon:checked ~ .hamb .hamb-line::after {
    transform: rotate(45deg);
    top: 0;
  }

  /* Less than large desktop */
  @media only screen and (max-width: 1087px) {
    .header-right li:not(:first-child)::before {
      margin-right: 16px;
      width: 1px;
      height: 40px;
      background-color: var(--divider-color);
      content: "";
    }
  }

  /* Large Desktops */
  @media only screen and (min-width: 1088px) {
    header {
      /* Header is not sticky on desktops */
      position: unset;
      border-bottom: 1px solid var(--divider-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .home {
      border-bottom: unset;
    }

    .container {
      flex-direction: row;
    }

    nav.menu {
      max-height: 100%;
      display: flex;
      flex-grow: 1;
      justify-content: space-between;
      box-shadow: none;
    }

    nav.menu ul {
      flex-direction: row;
      border-bottom: unset;
    }

    .header-right {
      max-height: 100%;
    }

    .hamb {
      display: none;
    }
  }

  /* Extra Large Desktops */
  @media only screen and (min-width: 1200px) {
    .home {
      padding-left: 0;
    }

    .header-right {
      margin-right: 0;
    }
  }
</style>

<script>
  // This script hide the header when scrolling down on mobile devices
  const header = document.querySelector("header")!;
  const headerHiddenClass = "header-hidden";
  const menuCheckbox = document.getElementById("menu-icon")! as HTMLInputElement;

  let prevScrollpos = window.scrollY;
  window.addEventListener("scroll", () => {
    const currentScrollPos = window.scrollY;

    // if scrolling down and the mobile menu is not opened, hide header
    if (currentScrollPos > prevScrollpos && !menuCheckbox.checked) {
      header.classList.add(headerHiddenClass);
    } else {
      header.classList.remove(headerHiddenClass);
    }
    prevScrollpos = currentScrollPos;
  });
</script>
