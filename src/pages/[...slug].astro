---
import { getCollection, type CollectionEntry } from "astro:content";

import Layout from "@layouts/BaseLayout.astro";
import MainContent from "@components/MainContent.astro";
import { isLanguage, type Language } from "@i18n/i18n";
import { translations } from "@i18n/translations";
import type { TranslationKey } from "@i18n/translations";

export async function getStaticPaths() {
  const blogEntries = await getCollection("blog");

  return blogEntries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

export const langFromSlug = (slug: CollectionEntry<"blog">["slug"]): Language => {
  let lang = slug.split("/")[0];
  if (!isLanguage(lang)) {
    throw new Error(`Unknown language contained in slug ${slug}`);
  }

  return lang;
};
const lang = langFromSlug(entry.slug);

const options: Intl.DateTimeFormatOptions = {
  year: "numeric",
  month: "long",
  day: "numeric",
};
const formatDate = (date: Date) => date.toLocaleDateString(lang, options);

const modified = entry.data.created.getTime() < entry.data.modified.getTime();

const translate_tags = (tag: string): unknown => {
  if (tag in translations.en) {
    return translations[lang][tag as TranslationKey];
  }
  throw Error(`Failed to translate tag: ${tag}`);
};
---

<Layout title={entry.data.title} lang={lang}>
  <MainContent class="post">
    <h1>{entry.data.title}</h1>
    <div class="info">
      <span class="date">
        {modified ? `last modify: ${formatDate(entry.data.modified)} | ` : undefined}
        create: {formatDate(entry.data.created)}
      </span>
      <span class="tags">
        <ul class="tagList">{entry.data.tags.map((tag) => <li>{translate_tags(tag)}</li>)}</ul>
      </span>
    </div>
    <Content />
  </MainContent>
</Layout>

<style>
  h1 {
    font-size: max(36px, 2em);
    line-height: 48px;
    font-weight: 400;
    margin: 100px 0;
  }

  .info {
    border-bottom: 1px solid var(--divider-color);
    padding-bottom: 4px;
    margin-bottom: 1rem;
    font-size: 13px;

    display: flex;
    justify-content: space-between;
  }

  .tagList {
    /* TODO: shouldn't need to reset list */
    list-style: none;
    margin: 0;

    display: flex;
  }

  .tagList li {
    margin: 0.2em 0.5em 0.2em 0px;

    padding: 0.4em 0.5em;
    font-weight: 700;
    font-size: 10px;
    border-radius: 0.285714rem;
    color: #fff;
    background-color: var(--tag-color);
  }

  .date {
    color: var(--secondary-color);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
</style>

<style is:global>
  /* sidenotes */
  .post aside {
    color: var(--aside-text-color);
    padding: 5px 10px;
    font-size: 13px;

    margin-bottom: 20px;
    background: var(--aside-sm-bg-color);
    border: solid 1px var(--aside-sm-border-color);
    border-bottom: solid 1px var(--aside-sm-border-bottom-color);
    border-radius: 10px;
  }

  @media only screen and (max-width: 1439px) {
    .post aside {
      margin-top: 0 !important;
    }
  }

  @media only screen and (min-width: 1440px) {
    .post aside {
      position: absolute;
      width: 240px;
      background: none;
      padding: 0 0 0 16px;
      border-radius: 0;
      border: none;
      border-left: 8px solid var(--aside-lg-border-color);
      right: calc((100% - var(--content-width)) / 2 - 237px);
    }
  }
</style>
